#!/usr/bin/env bash
set -o pipefail

# tmux セッション切替（ghq + $HOME/work + fzf）
# PREFIX + f から呼ばれる独立スクリプト

export PATH="$HOME/.homebrew/bin:$HOME/.local/bin:/usr/local/bin:$PATH"

ghq_root=$(ghq root)
candidates=$(
  ghq list | sed "s|^|${ghq_root}/|"
  find "$HOME/work" -mindepth 1 -maxdepth 1 -type d 2>/dev/null
)

selected=$(echo "$candidates" | fzf --prompt="tmux session > " --preview="ls -la {}")
if [ -z "$selected" ]; then
  exit 0
fi

session_name=$(basename "$selected")
project_dir=$selected

if tmux has-session -t "$session_name" 2>/dev/null; then
  if [ -n "$TMUX" ]; then
    tmux switch-client -t "$session_name"
  else
    tmux attach-session -t "$session_name"
  fi
else
  if [ -n "$TMUX" ]; then
    tmux new-session -d -s "$session_name" -c "$project_dir" && tmux switch-client -t "$session_name"
  else
    tmux new-session -s "$session_name" -c "$project_dir"
  fi
fi
